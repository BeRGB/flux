#!/usr/bin/env node
import { mkdir, writeFile } from 'node:fs/promises';
import { dirname, extname, resolve } from 'node:path';
import { fileURLToPath } from 'node:url';
import { load } from 'cheerio';

const products = [
	{
		slug: 'ador',
		name: 'Ador',
		url: 'https://www.fluxlasers.com/products/ador/',
		targetHeading: /Cutting\s*&\s*engraving/i,
	},
];

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = resolve(__dirname, '..');
const imageDir = resolve(rootDir, 'public', 'images', 'features');
const dataFile = resolve(rootDir, 'src', 'data', 'productFeatures.ts');

const fetchHtml = async (url) => {
	const response = await fetch(url, {
		headers: {
			'user-agent':
				'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.4 Safari/605.1.15',
		},
	});

	if (!response.ok) {
		throw new Error(`Failed to fetch ${url}: ${response.status} ${response.statusText}`);
	}

	return response.text();
};

const slugify = (value) => value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');

const cleanText = (value) => value.replace(/\s+/g, ' ').trim();

const downloadImage = async (url, fileName) => {
	const response = await fetch(url, {
		headers: {
			'user-agent':
				'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.4 Safari/605.1.15',
		},
	});

	if (!response.ok) {
		throw new Error(`Failed to download image ${url}: ${response.status} ${response.statusText}`);
	}

	const arrayBuffer = await response.arrayBuffer();
	await writeFile(resolve(imageDir, fileName), Buffer.from(arrayBuffer));
	return `/images/features/${fileName}`;
};

const extractFeature = async ($, product) => {
	const section = $('section')
		.filter((_, el) => product.targetHeading.test($(el).find('h2').first().text()))
		.first();

	if (!section.length) {
		console.warn(`⚠️  No feature section found for ${product.name}`);
		return null;
	}

	const heading = cleanText(section.find('h2').first().text());
	const subheading = cleanText(section.find('h3').first().text());
	const textColumn = section.find('div').filter((_, el) => $(el).find('h2').length).first();
	const bodyNodes = textColumn
		.find('p')
		.slice(0, 1)
		.map((_, el) => {
			const html = $(el).html()?.trim();
			return html ? `<p>${html}</p>` : null;
		})
		.get()
		.filter(Boolean);

	const imageEl = section.find('img').first();
	if (!imageEl.length) {
		console.warn(`⚠️  Feature section missing image for ${product.name}`);
		return null;
	}

	const src =
		imageEl.attr('src') ||
		imageEl.attr('data-src') ||
		(imageEl.attr('srcset') || '')
			.split(',')
			.map((entry) => entry.trim().split(' ')[0])
			.find(Boolean) ||
		null;

	if (!src) {
		console.warn(`⚠️  Could not determine image URL for feature section on ${product.name}`);
		return null;
	}

	const ext = extname(new URL(src, product.url).pathname) || '.jpg';
	const fileName = `${product.slug}-${slugify(heading)}${ext}`;

	return {
		heading,
		subheading: subheading || null,
		bodyHtml: bodyNodes.length ? bodyNodes : [],
		image: {
			src,
			alt: imageEl.attr('alt') ?? null,
			width: imageEl.attr('width') ?? null,
			height: imageEl.attr('height') ?? null,
			filename: fileName,
		},
	};
};

const serializeValue = (value) => JSON.stringify(value, (_, v) => (v === undefined ? null : v), '\t');

const main = async () => {
	await mkdir(imageDir, { recursive: true });
	const features = {};

	for (const product of products) {
		console.log(`Scraping feature section for ${product.name} (${product.url})…`);
		const html = await fetchHtml(product.url);
		const $ = load(html);
		const feature = await extractFeature($, product);
		if (!feature) continue;

		const localImage = await downloadImage(feature.image.src, feature.image.filename);
		features[product.slug] = {
			heading: feature.heading,
			subheading: feature.subheading,
			bodyHtml: feature.bodyHtml,
			image: {
				src: localImage,
				alt: feature.image.alt,
				width: feature.image.width,
				height: feature.image.height,
			},
		};
	}

	const fileContent = `// Auto-generated by scripts/scrape-product-features.mjs
// eslint-disable
export type ProductFeatureImage = {
\tsrc: string;
\talt: string | null;
\twidth: string | null;
\theight: string | null;
};

export type ProductFeature = {
\theading: string;
\tsubheading: string | null;
\tbodyHtml: string[];
\timage: ProductFeatureImage;
};

export const productFeatures = ${serializeValue(features)} as const;
`;

	await writeFile(dataFile, fileContent);
	console.log(`Saved feature data to ${dataFile}`);
};

main().catch((error) => {
	console.error(error);
	process.exitCode = 1;
});
