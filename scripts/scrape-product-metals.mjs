#!/usr/bin/env node
import { mkdir, writeFile } from 'node:fs/promises';
import { dirname, extname, resolve } from 'node:path';
import { fileURLToPath } from 'node:url';
import { load } from 'cheerio';

const products = [
	{
		slug: 'ador',
		name: 'Ador',
		url: 'https://www.fluxlasers.com/products/ador/',
		targetHeading: /Metal engraving/i,
	},
];

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = resolve(__dirname, '..');
const imageDir = resolve(rootDir, 'public', 'images', 'metals');
const dataFile = resolve(rootDir, 'src', 'data', 'productMetals.ts');

const fetchHtml = async (url) => {
	const response = await fetch(url, {
		headers: {
			'user-agent':
				'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.4 Safari/605.1.15',
		},
	});

	if (!response.ok) {
		throw new Error(`Failed to fetch ${url}: ${response.status} ${response.statusText}`);
	}

	return response.text();
};

const slugify = (value) => value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');

const cleanText = (value) => value.replace(/\s+/g, ' ').trim();

const downloadImage = async (url, filename) => {
	const response = await fetch(url, {
		headers: {
			'user-agent':
				'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.4 Safari/605.1.15',
		},
	});

	if (!response.ok) {
		throw new Error(`Failed to download ${url}: ${response.status} ${response.statusText}`);
	}

	const arrayBuffer = await response.arrayBuffer();
	await writeFile(resolve(imageDir, filename), Buffer.from(arrayBuffer));
	return `/images/metals/${filename}`;
};

const extractMetalCards = async ($, section, product) => {
	const list = $('#infrared-list');
	if (!list.length) return [];

	const cards = [];

	list.children('div').each((_, element) => {
		const $card = $(element);
		const $img = $card.find('img').first();
		const name = cleanText($card.find('p').first().text());
		if (!$img.length || !name) return;

		const src =
			$img.attr('src') ||
			($img.attr('srcset') || '')
				.split(',')
				.map((entry) => entry.trim().split(' ')[0])
				.find(Boolean);
		if (!src) return;

		const ext = extname(new URL(src, product.url).pathname) || '.jpg';
		const filename = `${product.slug}-${slugify(name)}${ext}`;
		const details = $card
			.find('p')
			.slice(1)
			.map((__, p) => cleanText($(p).text()))
			.get()
			.filter(Boolean);

		cards.push({
			name,
			details,
			image: {
				src,
				alt: $img.attr('alt') ?? name,
				width: $img.attr('width') ?? null,
				height: $img.attr('height') ?? null,
				filename,
			},
		});
	});

	return cards;
};

const extractMetalSection = async (product) => {
	const html = await fetchHtml(product.url);
	const $ = load(html);
	const section = $('section')
		.filter((_, el) => product.targetHeading.test($(el).find('h2').first().text()))
		.first();

	if (!section.length) {
		console.warn(`⚠️  Could not find metal section for ${product.name}`);
		return null;
	}

	const cards = await extractMetalCards($, section, product);
	if (!cards.length) {
		console.warn(`⚠️  No metal cards found for ${product.name}`);
		return null;
	}

	return {
		heading: 'Metals you can engrave',
		cards,
	};
};

const serializeValue = (value) => JSON.stringify(value, (_, v) => (v === undefined ? null : v), '\t');

const main = async () => {
	await mkdir(imageDir, { recursive: true });
	const results = {};

	for (const product of products) {
		console.log(`Scraping metal engraving section for ${product.name} (${product.url})…`);
		const data = await extractMetalSection(product);
		if (!data) continue;

		const cards = [];
		for (const card of data.cards) {
			const localSrc = await downloadImage(card.image.src, card.image.filename);
			cards.push({
				name: card.name,
				details: card.details,
				image: {
					src: localSrc,
					alt: card.image.alt,
					width: card.image.width,
					height: card.image.height,
				},
			});
		}

		results[product.slug] = {
			heading: data.heading,
			cards,
		};
	}

	const fileContent = `// Auto-generated by scripts/scrape-product-metals.mjs
// eslint-disable
export type ProductMetalCard = {
\tname: string;
\tdetails: string[];
\timage: { src: string; alt: string | null; width: string | null; height: string | null };
};

export type ProductMetalSection = {
\theading: string;
\tcards: ProductMetalCard[];
};

export const productMetals = ${serializeValue(results)} as const;
`;

	await writeFile(dataFile, fileContent);
	console.log(`Saved metal engraving data to ${dataFile}`);
};

main().catch((error) => {
	console.error(error);
	process.exitCode = 1;
});
