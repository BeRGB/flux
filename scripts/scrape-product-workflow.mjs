#!/usr/bin/env node
import { mkdir, writeFile } from 'node:fs/promises';
import { dirname, extname, resolve } from 'node:path';
import { fileURLToPath } from 'node:url';
import { load } from 'cheerio';

const products = [
	{
		slug: 'ador',
		name: 'Ador',
		url: 'https://www.fluxlasers.com/products/ador/',
	},
];

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = resolve(__dirname, '..');
const imageDir = resolve(rootDir, 'public', 'images', 'workflow');
const dataFile = resolve(rootDir, 'src', 'data', 'productWorkflow.ts');

const fetchHtml = async (url) => {
	const response = await fetch(url, {
		headers: {
			'user-agent':
				'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.4 Safari/605.1.15',
		},
	});

	if (!response.ok) {
		throw new Error(`Failed to fetch ${url}: ${response.status} ${response.statusText}`);
	}

	return response.text();
};

const slugify = (value) => value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');

const cleanText = (value) => value.replace(/\s+/g, ' ').trim();

const downloadImage = async (url, fileName) => {
	const response = await fetch(url, {
		headers: {
			'user-agent':
				'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.4 Safari/605.1.15',
		},
	});

	if (!response.ok) {
		throw new Error(`Failed to download image ${url}: ${response.status} ${response.statusText}`);
	}

	const arrayBuffer = await response.arrayBuffer();
	await writeFile(resolve(imageDir, fileName), Buffer.from(arrayBuffer));
	return `/images/workflow/${fileName}`;
};

const extractWorkflow = async ($, product) => {
	const section = $('section')
		.filter((_, el) => /User-friendly experience/i.test($(el).find('h2').first().text()))
		.first();

	if (!section.length) {
		console.warn(`⚠️  No workflow section found for ${product.name}`);
		return null;
	}

	const heading = cleanText(section.find('h2').first().text());
	const description = cleanText(section.find('p').first().text());
	const steps = [];

	section
		.find('.grid')
		.first()
		.children()
		.each((index, element) => {
			const $step = $(element);
			const $img = $step.find('img').first();
			const title = cleanText($step.find('p.h5').first().text());
			const copy = cleanText(
				$step
					.find('p')
					.not('.h5')
					.first()
					.text()
			);

			if (!$img.length || !title) {
				return;
			}

			const src =
				$img.attr('src') ||
				$img.attr('data-src') ||
				($img.attr('srcset') || '')
					.split(',')
					.map((entry) => entry.trim().split(' ')[0])
					.find(Boolean) ||
				null;

			if (!src) {
				return;
			}

			const ext = extname(new URL(src, product.url).pathname) || '.jpg';
			const filename = `${product.slug}-${slugify(title)}${ext}`;
			steps.push({
				title,
				description: copy,
				image: {
					src,
					alt: $img.attr('alt') ?? null,
					width: $img.attr('width') ?? null,
					height: $img.attr('height') ?? null,
				},
				localImage: filename,
			});
		});

	if (!steps.length) {
		console.warn(`⚠️  No workflow steps detected for ${product.name}`);
		return null;
	}

	return {
		heading,
		description,
		steps,
	};
};

const serializeValue = (value) => JSON.stringify(value, (_, v) => (v === undefined ? null : v), '\t');

const main = async () => {
	await mkdir(imageDir, { recursive: true });

	const workflows = {};

	for (const product of products) {
		console.log(`Scraping workflow for ${product.name} (${product.url})…`);
		const html = await fetchHtml(product.url);
		const $ = load(html);
		const workflow = await extractWorkflow($, product);
		if (!workflow) continue;

		const steps = [];
		for (const step of workflow.steps) {
			const localSrc = await downloadImage(step.image.src, step.localImage);
			steps.push({
				title: step.title,
				description: step.description,
				image: {
					src: localSrc,
					alt: step.image.alt,
					width: step.image.width,
					height: step.image.height,
				},
			});
		}

		workflows[product.slug] = {
			heading: workflow.heading,
			description: workflow.description,
			steps,
		};
	}

	const fileContent = `// Auto-generated by scripts/scrape-product-workflow.mjs
// eslint-disable
export type ProductWorkflowStep = {
\ttitle: string;
\tdescription: string;
\timage: { src: string; alt: string | null; width: string | null; height: string | null };
};

export type ProductWorkflow = {
\theading: string;
\tdescription: string;
\tsteps: ProductWorkflowStep[];
};

export const productWorkflow = ${serializeValue(workflows)} as const;
`;

	await writeFile(dataFile, fileContent);
	console.log(`Saved workflow data to ${dataFile}`);
};

main().catch((error) => {
	console.error(error);
	process.exitCode = 1;
});
